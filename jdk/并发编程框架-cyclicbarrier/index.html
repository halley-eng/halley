<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>并发编程框架 CyclicBarrier - 月亮</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="并发编程框架 CyclicBarrier"><meta property="og:description" content="数据结构 /** * 锁屏障 * The lock for guarding barrier entry */ private final ReentrantLock lock = new ReentrantLock(); /** * 条件变量 * Condition to wait on until tripped */ private final Condition trip = lock.newCondition(); /** 参与方数量 The number of parties */ private final int parties; /* 各参与方都到位后的触发命令 The command to run when tripped */ private final Runnable barrierCommand; /** 当前代 The current generation */ private Generation generation = new Generation(); /** * 当前代未到位的参与方数量 * Number of parties still waiting."><meta property="og:type" content="article"><meta property="og:url" content="https://halley-eng.github.io/halley/jdk/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6-cyclicbarrier/"><meta property="article:published_time" content="2020-11-25T21:37:30+08:00"><meta property="article:modified_time" content="2020-11-25T21:37:30+08:00"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/halley/css/style.css><link rel="shortcut icon" href=/halley/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/halley/ title=月亮 rel=home><div class="logo__item logo__text"><div class=logo__title>月亮</div><div class=logo__tagline>每天进步一点点</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/halley/jdk/><i class="fa fa-road"></i><span class=menu__text>JDK</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/%E7%AE%97%E6%B3%95/><i class="fa fa-road"></i><span class=menu__text>算法</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/axon/><i class="fa fa-road"></i><span class=menu__text>Axon</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/><i class="fa fa-road"></i><span class=menu__text>源码阅读</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/about/><span class=menu__text>关于作者</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>并发编程框架 CyclicBarrier</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-11-25T21:37:30+08:00>November 25, 2020</time></div></div></header><div class="content post__content clearfix"><p><img src=https://cdn.jsdelivr.net/gh/halley-eng/halley/static/images/jdk/concurrent/cyclicbarrier.jpg alt=ss></p><h3 id=数据结构>数据结构</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * 锁屏障
</span><span style=color:#75715e>     * The lock for guarding barrier entry */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ReentrantLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReentrantLock<span style=color:#f92672>();</span>
    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * 条件变量
</span><span style=color:#75715e>     * Condition to wait on until tripped */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Condition trip <span style=color:#f92672>=</span> lock<span style=color:#f92672>.</span><span style=color:#a6e22e>newCondition</span><span style=color:#f92672>();</span>

    <span style=color:#75715e>/** 参与方数量 The number of parties */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> parties<span style=color:#f92672>;</span>
    <span style=color:#75715e>/*  各参与方都到位后的触发命令 The command to run when tripped */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Runnable barrierCommand<span style=color:#f92672>;</span>
    <span style=color:#75715e>/** 当前代 The current generation */</span>
    <span style=color:#66d9ef>private</span> Generation generation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Generation<span style=color:#f92672>();</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * 当前代未到位的参与方数量
</span><span style=color:#75715e>     * Number of parties still waiting. Counts down from parties to 0
</span><span style=color:#75715e>     * on each generation.  It is reset to parties on each new
</span><span style=color:#75715e>     * generation or when broken.
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> count<span style=color:#f92672>;</span>
</code></pre></div><h3 id=await>await</h3><p>各参与方通过调用await相关方法</p><ol><li>使用同步锁 lock</li><li>依次到达屏障处, 除非最后一个到达都会阻塞在屏障处</li><li>最后一个到达后执行后置命令, 并退出</li></ol><pre><code>/**
     * Main barrier code, covering the various policies.
     */
    private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException,
               TimeoutException {
        // 1. 各个线程以同步的方式进入到循环屏障;
        final ReentrantLock lock = this.lock;
        lock.lock();

        try {
            final Generation g = generation;
            // 2. 第一次检测当前代的broken标识;
            if (g.broken)
                throw new BrokenBarrierException();

            // 3. 响应中断
            if (Thread.interrupted()) {
                breakBarrier();
                throw new InterruptedException();
            }

            // 4. 当前是最后一个线程, 去执行相应的action, 最后一个线程不用去加入条件队列进入阻塞的流程;
            int index = --count;  // 更新剩余等待的线程数目；
            if (index == 0) {  // tripped
                boolean ranAction = false;
                try {
                    //
                    final Runnable command = barrierCommand;
                    if (command != null)
                        command.run();

                    ranAction = true; // 标记已经运行过action
                    nextGeneration(); // 唤醒其他人, 并重新初始化下一代;
                    return 0;
                } finally {
                    if (!ranAction)
                        breakBarrier();
                }
            }

            // loop until tripped, broken, interrupted, or timed out
            // 5. 循环直到broken，中断或超时
            for (;;) {
                try {
                    // 5.1 没有设置超时时间, 直接丢进条件队列, 需要等待该条件被notify
                    if (!timed)
                        trip.await();
                    // 5.2 设置超时时间的等待: 支持超时响应的加入条件队列;
                    else if (nanos &gt; 0L) // 继续等待;
                        nanos = trip.awaitNanos(nanos);

                } catch (InterruptedException ie) {
                    // 5.3 中断退出;
                    if (g == generation &amp;&amp; ! g.broken) {
                        breakBarrier(); // 更新当前代标示, 并触发各等待线程继续执行;
                        throw ie;   // 抛出异常;
                    } else {
                    // 5.4
                        // We're about to finish waiting even if we had not
                        // been interrupted, so this interrupt is deemed to
                        // &quot;belong&quot; to subsequent execution.
                        Thread.currentThread().interrupt();
                    }
                }

                // 5.5 第二次检测broken标示,
                if (g.broken)
                    throw new BrokenBarrierException();
                // 5.6 当前处理代被异常结束；
                if (g != generation)
                    return index;

                // 5.7 设置了超时时间, 并且超时则标记当前代结束，并开启下一代;
                if (timed &amp;&amp; nanos &lt;= 0L) {
                    breakBarrier();
                    throw new TimeoutException();
                }
            }

        } finally {
            // 解锁;
            lock.unlock();
        }
    }
</code></pre><h3 id=重置锁屏障>重置锁屏障</h3><ol><li>获取锁</li><li>breakBarrier: 对当前代的Generate添加中断标识;</li><li>nextGeneration: 开启下一代，并唤醒</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  
     <span style=color:#75715e>/**
</span><span style=color:#75715e>     * Resets the barrier to its initial state.  If any parties are
</span><span style=color:#75715e>     * currently waiting at the barrier, they will return with a
</span><span style=color:#75715e>     * {@link BrokenBarrierException}. Note that resets &lt;em&gt;after&lt;/em&gt;
</span><span style=color:#75715e>     * a breakage has occurred for other reasons can be complicated to
</span><span style=color:#75715e>     * carry out; threads need to re-synchronize in some other way,
</span><span style=color:#75715e>     * and choose one to perform the reset.  It may be preferable to
</span><span style=color:#75715e>     * instead create a new barrier for subsequent use.
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>reset</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>final</span> ReentrantLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>;</span>
        lock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            breakBarrier<span style=color:#f92672>();</span>   <span style=color:#75715e>// break the current generation
</span><span style=color:#75715e></span>            nextGeneration<span style=color:#f92672>();</span> <span style=color:#75715e>// start a new generation
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
            lock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><ol><li>更新broken标示</li><li>唤醒当前代所有的等待者<ol><li>这些等待着会被唤醒, 然后检测broken标示, 并因此抛出BrokenBarrierException异常</li></ol></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * 将当前的障碍生成设置为已破坏并唤醒相关方。
</span><span style=color:#75715e>     * 仅在保持锁定状态下调用。
</span><span style=color:#75715e>     * Sets current barrier generation as broken and wakes up everyone.
</span><span style=color:#75715e>     * Called only while holding lock.
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>breakBarrier</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        generation<span style=color:#f92672>.</span><span style=color:#a6e22e>broken</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
        count <span style=color:#f92672>=</span> parties<span style=color:#f92672>;</span>
        trip<span style=color:#f92672>.</span><span style=color:#a6e22e>signalAll</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

</code></pre></div><p>开始下一代, 其中会</p><ol><li>先唤醒上一代所有的等待者<ol><li>这些等待着会被唤醒, 然后检测broken标示, 并因此抛出BrokenBarrierException异常</li></ol></li><li>重新初始化下一代上下文;</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * Updates state on barrier trip and wakes up everyone.
</span><span style=color:#75715e>     * Called only while holding lock.
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>nextGeneration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// signal completion of last generation
</span><span style=color:#75715e></span>        trip<span style=color:#f92672>.</span><span style=color:#a6e22e>signalAll</span><span style=color:#f92672>();</span>
        <span style=color:#75715e>// set up next generation
</span><span style=color:#75715e></span>        count <span style=color:#f92672>=</span> parties<span style=color:#f92672>;</span>
        generation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Generation<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h3 id=demo>Demo</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  
 <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Solver</span> <span style=color:#f92672>{</span>
   <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> N<span style=color:#f92672>;</span>
   <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span><span style=color:#f92672>[][]</span> data<span style=color:#f92672>;</span>
   <span style=color:#66d9ef>final</span> CyclicBarrier barrier<span style=color:#f92672>;</span>
  
   <span style=color:#75715e>// 每个工作对象处理一行, 之后进入await, 
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Worker</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
     <span style=color:#66d9ef>int</span> myRow<span style=color:#f92672>;</span>
     Worker<span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> row<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> myRow <span style=color:#f92672>=</span> row<span style=color:#f92672>;</span> <span style=color:#f92672>}</span>
     <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
       <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>done<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
         processRow<span style=color:#f92672>(</span>myRow<span style=color:#f92672>);</span>

         <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
           barrier<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>();</span>
         <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
         <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>BrokenBarrierException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
         <span style=color:#f92672>}</span>
       <span style=color:#f92672>}</span>
     <span style=color:#f92672>}</span>
   <span style=color:#f92672>}</span>

   <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Solver</span><span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>[][]</span> matrix<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
     data <span style=color:#f92672>=</span> matrix<span style=color:#f92672>;</span>
     N <span style=color:#f92672>=</span> matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
     Runnable barrierAction <span style=color:#f92672>=</span>
       <span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> 
            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span> mergeRows<span style=color:#f92672>(...);</span> <span style=color:#f92672>}</span>
       <span style=color:#f92672>};</span>
     barrier <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CyclicBarrier<span style=color:#f92672>(</span>N<span style=color:#f92672>,</span> barrierAction<span style=color:#f92672>);</span>

     List<span style=color:#f92672>&lt;</span>Thread<span style=color:#f92672>&gt;</span> threads <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>Thread<span style=color:#f92672>&gt;(</span>N<span style=color:#f92672>);</span>
     <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> N<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
       Thread thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Worker<span style=color:#f92672>(</span>i<span style=color:#f92672>));</span>
       threads<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>thread<span style=color:#f92672>);</span>
       thread<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
   <span style=color:#f92672>}</span>
</code></pre></div><h3 id=总结>总结</h3><p>CylicBarrier 对外方法只有await, reset 两个。 共同实现每count次触发一次屏障命令command, 并唤醒相关方继续执行的操作;</p></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Halley avatar" src=/halley/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Halley</span></div><div class=authorbox__description>I&rsquo;am interest in compute sience</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/halley/jdk/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6-semaphore/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>并发编程框架 Semaphore</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/halley/jdk/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6-countdownlatch/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>并发编程框架 CountDown</p></a></div></nav></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH... name=q aria-label=SEARCH...></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://halley-eng.github.io/halley/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E5%9B%9E%E6%BA%AF%E9%A2%98%E7%9B%AE/>回溯题目</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E8%9E%BA%E6%97%8B%E7%9F%A9%E9%98%B5/>螺旋矩阵</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E5%88%86%E6%B2%BB%E9%A2%98%E7%9B%AE%E7%AF%87/>分治题目篇</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E6%89%91%E5%85%8B%E7%89%8C%E9%97%AE%E9%A2%98/>扑克牌问题</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E6%A0%B9%E6%8D%AE%E6%95%B0%E5%AD%97%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%8B1%E7%9A%84%E6%95%B0%E7%9B%AE%E6%8E%92%E5%BA%8F_1356/>根据数字二进制下1的数目排序_1356</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/halley/tags/mybatis/ title=mybatis>mybatis</a>
<a class="widget-taglist__link widget__link btn" href=/halley/tags/shardingspare/ title=shardingspare>shardingspare</a>
<a class="widget-taglist__link widget__link btn" href=/halley/tags/spring/ title=spring>spring</a>
<a class="widget-taglist__link widget__link btn" href=/halley/tags/spring-boot/ title=spring-boot>spring-boot</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2020 月亮.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/halley/js/menu.js></script></body></html>