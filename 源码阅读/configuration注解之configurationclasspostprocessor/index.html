<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Configuration注解之ConfigurationClassPostProcessor - 月亮</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="Configuration注解之ConfigurationClassPostProcessor"><meta property="og:description" content="运行时机 BeanDefinitionRegistryPostProcessor 钩子 通过实现 BeanDefinitionRegistryPostProcessor 接口, 可以在IOC容器刷新阶段的调用, 如下方法
/** * Derive further bean definitions from the configuration classes in the registry. */ @Override public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) { // 1. 保证IOC容器只能处理一次; 	int registryId = System.identityHashCode(registry); if (this.registriesPostProcessed.contains(registryId)) { throw new IllegalStateException( &#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34; + registry); } if (this.factoriesPostProcessed.contains(registryId)) { throw new IllegalStateException( &#34;postProcessBeanFactory already called on this post-processor against &#34; + registry); } this."><meta property="og:type" content="article"><meta property="og:url" content="https://halley-eng.github.io/halley/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/configuration%E6%B3%A8%E8%A7%A3%E4%B9%8Bconfigurationclasspostprocessor/"><meta property="article:published_time" content="2020-12-22T21:39:16+08:00"><meta property="article:modified_time" content="2020-12-22T21:39:16+08:00"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/halley/css/style.css><link rel="shortcut icon" href=/halley/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/halley/ title=月亮 rel=home><div class="logo__item logo__text"><div class=logo__title>月亮</div><div class=logo__tagline>每天进步一点点</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/halley/jdk/><i class="fa fa-road"></i><span class=menu__text>JDK</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/%E7%AE%97%E6%B3%95/><i class="fa fa-road"></i><span class=menu__text>算法</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/axon/><i class="fa fa-road"></i><span class=menu__text>Axon</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/><i class="fa fa-road"></i><span class=menu__text>源码阅读</span>
<span class=alert></span></a></li><li class=menu__item><a class=menu__link href=/halley/about/><span class=menu__text>关于作者</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Configuration注解之ConfigurationClassPostProcessor</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-12-22T21:39:16+08:00>December 22, 2020</time></div></div></header><div class="content post__content clearfix"><p><img src=https://halley-image.oss-cn-beijing.aliyuncs.com/2020/12/22/16086516575111.jpg alt></p><h3 id=运行时机>运行时机</h3><h4 id=beandefinitionregistrypostprocessor-钩子>BeanDefinitionRegistryPostProcessor 钩子</h4><p>通过实现 BeanDefinitionRegistryPostProcessor 接口, 可以在IOC容器刷新阶段的调用, 如下方法</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#75715e>/**
</span><span style=color:#75715e>	 * Derive further bean definitions from the configuration classes in the registry.
</span><span style=color:#75715e>	 */</span>
	<span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postProcessBeanDefinitionRegistry</span><span style=color:#f92672>(</span>BeanDefinitionRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		<span style=color:#75715e>// 1. 保证IOC容器只能处理一次;
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>int</span> registryId <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>identityHashCode</span><span style=color:#f92672>(</span>registry<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>registriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>registryId<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
					<span style=color:#e6db74>&#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34;</span> <span style=color:#f92672>+</span> registry<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factoriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>registryId<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
					<span style=color:#e6db74>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#f92672>+</span> registry<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>registriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>registryId<span style=color:#f92672>);</span>

		<span style=color:#75715e>// 2. 处理所有的bean定义;
</span><span style=color:#75715e></span>		processConfigBeanDefinitions<span style=color:#f92672>(</span>registry<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>

</code></pre></div><h4 id=beanfactorypostprocessor-钩子>BeanFactoryPostProcessor 钩子</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#75715e>/**
</span><span style=color:#75715e>	 * Prepare the Configuration classes for servicing bean requests at runtime
</span><span style=color:#75715e>	 * by replacing them with CGLIB-enhanced subclasses.
</span><span style=color:#75715e>	 */</span>
	<span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postProcessBeanFactory</span><span style=color:#f92672>(</span>ConfigurableListableBeanFactory beanFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>int</span> factoryId <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>identityHashCode</span><span style=color:#f92672>(</span>beanFactory<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factoriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>factoryId<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
					<span style=color:#e6db74>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#f92672>+</span> beanFactory<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factoriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>factoryId<span style=color:#f92672>);</span>
		<span style=color:#75715e>// 1. 加载并处理IOC容器中Configuration对象: 注册BeanDefinition;
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>registriesPostProcessed</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>factoryId<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#75715e>// BeanDefinitionRegistryPostProcessor hook apparently not supported...
</span><span style=color:#75715e></span>			<span style=color:#75715e>// Simply call processConfigurationClasses lazily at this point then.
</span><span style=color:#75715e></span>			processConfigBeanDefinitions<span style=color:#f92672>((</span>BeanDefinitionRegistry<span style=color:#f92672>)</span> beanFactory<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#75715e>// 2. 增强Configuration 对象: 使得任何相关方法的调用都经过代理, 代理会结合注解返回合适的对象;
</span><span style=color:#75715e></span>		enhanceConfigurationClasses<span style=color:#f92672>(</span>beanFactory<span style=color:#f92672>);</span>
		<span style=color:#75715e>// 3. 注册 ImportAwareBeanPostProcessor 使得配置类能够感知到上有配置类;
</span><span style=color:#75715e></span>		beanFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>addBeanPostProcessor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ImportAwareBeanPostProcessor<span style=color:#f92672>(</span>beanFactory<span style=color:#f92672>));</span>
	<span style=color:#f92672>}</span>
</code></pre></div><h3 id=解析并注册beandefinition>解析并注册BeanDefinition</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#75715e>// 1. 收集配置类名称
</span><span style=color:#75715e></span>		List<span style=color:#f92672>&lt;</span>BeanDefinitionHolder<span style=color:#f92672>&gt;</span> configCandidates <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
		String<span style=color:#f92672>[]</span> candidateNames <span style=color:#f92672>=</span> registry<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinitionNames</span><span style=color:#f92672>();</span>

		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String beanName <span style=color:#f92672>:</span> candidateNames<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			BeanDefinition beanDef <span style=color:#f92672>=</span> registry<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinition</span><span style=color:#f92672>(</span>beanName<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isFullConfigurationClass</span><span style=color:#f92672>(</span>beanDef<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
					ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isLiteConfigurationClass</span><span style=color:#f92672>(</span>beanDef<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>logger<span style=color:#f92672>.</span><span style=color:#a6e22e>isDebugEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
					logger<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Bean definition has already been processed as a configuration class: &#34;</span> <span style=color:#f92672>+</span> beanDef<span style=color:#f92672>);</span>
				<span style=color:#f92672>}</span>
			<span style=color:#f92672>}</span>
			<span style=color:#75715e>// 收集bean的名称;
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>checkConfigurationClassCandidate</span><span style=color:#f92672>(</span>beanDef<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>metadataReaderFactory</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
				configCandidates<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BeanDefinitionHolder<span style=color:#f92672>(</span>beanDef<span style=color:#f92672>,</span> beanName<span style=color:#f92672>));</span>
			<span style=color:#f92672>}</span>
		<span style=color:#f92672>}</span>

		<span style=color:#75715e>// 如果未收集到则直接短路;
</span><span style=color:#75715e></span>		<span style=color:#75715e>// Return immediately if no @Configuration classes were found
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>configCandidates<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		<span style=color:#75715e>// 2. 将配置类按照优先级 进行排序;
</span><span style=color:#75715e></span>		<span style=color:#75715e>// Sort by previously determined @Order value, if applicable
</span><span style=color:#75715e></span>		configCandidates<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>((</span>bd1<span style=color:#f92672>,</span> bd2<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>int</span> i1 <span style=color:#f92672>=</span> ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getOrder</span><span style=color:#f92672>(</span>bd1<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinition</span><span style=color:#f92672>());</span>
			<span style=color:#66d9ef>int</span> i2 <span style=color:#f92672>=</span> ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getOrder</span><span style=color:#f92672>(</span>bd2<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinition</span><span style=color:#f92672>());</span>
			<span style=color:#66d9ef>return</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>compare</span><span style=color:#f92672>(</span>i1<span style=color:#f92672>,</span> i2<span style=color:#f92672>);</span>
		<span style=color:#f92672>});</span>

   		<span style=color:#75715e>// 3. 当前 PostProcessor 引用到 容器中的 BeanNameGenerator
</span><span style=color:#75715e></span>		<span style=color:#75715e>// Detect any custom bean name generation strategy supplied through the enclosing application context
</span><span style=color:#75715e></span>		SingletonBeanRegistry sbr <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>registry <span style=color:#66d9ef>instanceof</span> SingletonBeanRegistry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			sbr <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SingletonBeanRegistry<span style=color:#f92672>)</span> registry<span style=color:#f92672>;</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>localBeanNameGeneratorSet</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				BeanNameGenerator generator <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>BeanNameGenerator<span style=color:#f92672>)</span> sbr<span style=color:#f92672>.</span><span style=color:#a6e22e>getSingleton</span><span style=color:#f92672>(</span>CONFIGURATION_BEAN_NAME_GENERATOR<span style=color:#f92672>);</span>
				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>generator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
					<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>componentScanBeanNameGenerator</span> <span style=color:#f92672>=</span> generator<span style=color:#f92672>;</span>
					<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>importBeanNameGenerator</span> <span style=color:#f92672>=</span> generator<span style=color:#f92672>;</span>
				<span style=color:#f92672>}</span>
			<span style=color:#f92672>}</span>
		<span style=color:#f92672>}</span>
		<span style=color:#75715e>// 4. 初始化环境变量
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardEnvironment<span style=color:#f92672>();</span>
		<span style=color:#f92672>}</span>

		<span style=color:#75715e>// 5. 初始化解析器
</span><span style=color:#75715e></span>		<span style=color:#75715e>// Parse each @Configuration class
</span><span style=color:#75715e></span>		ConfigurationClassParser parser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigurationClassParser<span style=color:#f92672>(</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>metadataReaderFactory</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>problemReporter</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>,</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resourceLoader</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>componentScanBeanNameGenerator</span><span style=color:#f92672>,</span> registry<span style=color:#f92672>);</span>

		<span style=color:#75715e>// 6. 循环解析所有配置类, 这样可以支持配置类中包含配置类这种嵌套场景;
</span><span style=color:#75715e></span>		Set<span style=color:#f92672>&lt;</span>BeanDefinitionHolder<span style=color:#f92672>&gt;</span> candidates <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashSet<span style=color:#f92672>&lt;&gt;(</span>configCandidates<span style=color:#f92672>);</span>
		Set<span style=color:#f92672>&lt;</span>ConfigurationClass<span style=color:#f92672>&gt;</span> alreadyParsed <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;&gt;(</span>configCandidates<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>());</span>
		<span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>
			<span style=color:#75715e>// 6.1 解析并验证
</span><span style=color:#75715e></span>			parser<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>candidates<span style=color:#f92672>);</span>
			parser<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>();</span>

			Set<span style=color:#f92672>&lt;</span>ConfigurationClass<span style=color:#f92672>&gt;</span> configClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashSet<span style=color:#f92672>&lt;&gt;(</span>parser<span style=color:#f92672>.</span><span style=color:#a6e22e>getConfigurationClasses</span><span style=color:#f92672>());</span>
			configClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>removeAll</span><span style=color:#f92672>(</span>alreadyParsed<span style=color:#f92672>);</span>
			<span style=color:#75715e>// 6.2 初始化BeanDefinitionReader
</span><span style=color:#75715e></span>			<span style=color:#75715e>// Read the model and create bean definitions based on its content
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>reader</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>reader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigurationClassBeanDefinitionReader<span style=color:#f92672>(</span>
						registry<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sourceExtractor</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resourceLoader</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>,</span>
						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>importBeanNameGenerator</span><span style=color:#f92672>,</span> parser<span style=color:#f92672>.</span><span style=color:#a6e22e>getImportRegistry</span><span style=color:#f92672>());</span>
			<span style=color:#f92672>}</span>
			<span style=color:#75715e>// 6.3 从配置类解析结果中注册相关 BeanDefinition 到容器中;
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>reader</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadBeanDefinitions</span><span style=color:#f92672>(</span>configClasses<span style=color:#f92672>);</span>
			alreadyParsed<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>configClasses<span style=color:#f92672>);</span>
			<span style=color:#75715e>// 6.4 清空候选解析容器, 并从bean容器中筛选可能新的Configuration类, 将其加入candidate中, 等待下一轮迭代;
</span><span style=color:#75715e></span>			candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>registry<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinitionCount</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> candidateNames<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				String<span style=color:#f92672>[]</span> newCandidateNames <span style=color:#f92672>=</span> registry<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinitionNames</span><span style=color:#f92672>();</span>
				Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> oldCandidateNames <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;&gt;(</span>Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>asList</span><span style=color:#f92672>(</span>candidateNames<span style=color:#f92672>));</span>
				Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> alreadyParsedClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;&gt;();</span>
				<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ConfigurationClass configurationClass <span style=color:#f92672>:</span> alreadyParsed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
					alreadyParsedClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>configurationClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getMetadata</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClassName</span><span style=color:#f92672>());</span>
				<span style=color:#f92672>}</span>
				<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String candidateName <span style=color:#f92672>:</span> newCandidateNames<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
					<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>oldCandidateNames<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>candidateName<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
						BeanDefinition bd <span style=color:#f92672>=</span> registry<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanDefinition</span><span style=color:#f92672>(</span>candidateName<span style=color:#f92672>);</span>
						<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ConfigurationClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>checkConfigurationClassCandidate</span><span style=color:#f92672>(</span>bd<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>metadataReaderFactory</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
								<span style=color:#f92672>!</span>alreadyParsedClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>bd<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeanClassName</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
							candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BeanDefinitionHolder<span style=color:#f92672>(</span>bd<span style=color:#f92672>,</span> candidateName<span style=color:#f92672>));</span>
						<span style=color:#f92672>}</span>
					<span style=color:#f92672>}</span>
				<span style=color:#f92672>}</span>
				candidateNames <span style=color:#f92672>=</span> newCandidateNames<span style=color:#f92672>;</span>
			<span style=color:#f92672>}</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>());</span>

		<span style=color:#75715e>// 7. 注册当前配置栈
</span><span style=color:#75715e></span>		<span style=color:#75715e>// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sbr <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>sbr<span style=color:#f92672>.</span><span style=color:#a6e22e>containsSingleton</span><span style=color:#f92672>(</span>IMPORT_REGISTRY_BEAN_NAME<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			sbr<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSingleton</span><span style=color:#f92672>(</span>IMPORT_REGISTRY_BEAN_NAME<span style=color:#f92672>,</span> parser<span style=color:#f92672>.</span><span style=color:#a6e22e>getImportRegistry</span><span style=color:#f92672>());</span>
		<span style=color:#f92672>}</span>

		<span style=color:#75715e>// 8. 清空metadata缓存;
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>metadataReaderFactory</span> <span style=color:#66d9ef>instanceof</span> CachingMetadataReaderFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#75715e>// Clear cache in externally provided MetadataReaderFactory; this is a no-op
</span><span style=color:#75715e></span>			<span style=color:#75715e>// for a shared cache since it&#39;ll be cleared by the ApplicationContext.
</span><span style=color:#75715e></span>			<span style=color:#f92672>((</span>CachingMetadataReaderFactory<span style=color:#f92672>)</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>metadataReaderFactory</span><span style=color:#f92672>).</span><span style=color:#a6e22e>clearCache</span><span style=color:#f92672>();</span>
		<span style=color:#f92672>}</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>主要逻辑为:</p><ol><li>收集配置类名称</li><li>排序</li><li>当前 PostProcessor 引用到 容器中的 BeanNameGenerator</li><li>初始化环境变量</li><li>初始化解析器</li><li>迭代解析所有配置类(支持嵌套)<ol><li>解析并验证</li><li>初始化BeanDefinitionReader</li><li>从配置类解析结果中注册相关 BeanDefinition 到容器中</li><li>清空候选解析容器, 并从bean容器中筛选可能新的Configuration类, 将其加入candidate中, 等待下一轮迭代;</li></ol></li><li>注册当前配置栈</li><li>清空meta缓存</li></ol><h3 id=注册相关>注册相关</h3><p>AnnotatedBeanDefinitionReader#AnnotatedBeanDefinitionReader(BeanDefinitionRegistry, Environment)
AnnotationConfigUtils#registerAnnotationConfigProcessors(BeanDefinitionRegistry, Object)</p><p>在这里会注册</p><ol><li>ContextAnnotationAutowireCandidateResolver</li><li>ConfigurationClassPostProcessor</li><li>AutowiredAnnotationBeanPostProcessor</li><li>jsr250Present && CommonAnnotationBeanPostProcessor</li><li>jpaPresent && PersistenceAnnotationBeanPostProcessor</li><li>EventListenerMethodProcessor</li><li>DefaultEventListenerFactory</li></ol></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Halley avatar" src=/halley/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Halley</span></div><div class=authorbox__description>I&rsquo;am interest in compute sience</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/halley/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/jdbctemplate%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>JdbcTemplate相关源码</p></a></div></nav></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH... name=q aria-label=SEARCH...></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://halley-eng.github.io/halley/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E5%9B%9E%E6%BA%AF%E9%A2%98%E7%9B%AE/>回溯题目</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E8%9E%BA%E6%97%8B%E7%9F%A9%E9%98%B5/>螺旋矩阵</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E5%88%86%E6%B2%BB%E9%A2%98%E7%9B%AE%E7%AF%87/>分治题目篇</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E6%89%91%E5%85%8B%E7%89%8C%E9%97%AE%E9%A2%98/>扑克牌问题</a></li><li class=widget__item><a class=widget__link href=/halley/%E7%AE%97%E6%B3%95/%E6%A0%B9%E6%8D%AE%E6%95%B0%E5%AD%97%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%8B1%E7%9A%84%E6%95%B0%E7%9B%AE%E6%8E%92%E5%BA%8F_1356/>根据数字二进制下1的数目排序_1356</a></li></ul></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2020 月亮.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/halley/js/menu.js></script></body></html>